-- This script creates a customer_transaction table and uses trans_dte to create
-- a range partition based on quarters. In addition, this range partition uses the
-- INTERVAL clause to automatically create new quarterly partitions when records with
-- dates beyond the 01-JAN-2024 date are inserted or updated. The script also alters
-- the customer_transaction table and makes the p_trx22q1 partition read only.

-- Table customer_transaction.
CREATE TABLE customer_transactions 
(customer_id   NUMBER(10) PRIMARY KEY,
 trans_dte     DATE,
 trans_amt     NUMBER(9,2),
 region_cd     VARCHAR2(4),
 processed_flg VARCHAR2(1))
PARTITION BY RANGE (trans_dte)
INTERVAL(NUMTOYMINTERVAL(3,'MONTH'))
(PARTITION p_trx22q1 VALUES LESS THAN (TO_DATE('01-APR-2022', 'DD-MON-YYYY')),
 PARTITION p_trx22q2 VALUES LESS THAN (TO_DATE('01-JUL-2022', 'DD-MON-YYYY')),
 PARTITION p_trx22q3 VALUES LESS THAN (TO_DATE('01-OCT-2022', 'DD-MON-YYYY')),
 PARTITION p_trx22q4 VALUES LESS THAN (TO_DATE('01-JAN-2023', 'DD-MON-YYYY')),
 PARTITION p_trx23q1 VALUES LESS THAN (TO_DATE('01-APR-2023', 'DD-MON-YYYY')),
 PARTITION p_trx23q2 VALUES LESS THAN (TO_DATE('01-JUL-2023', 'DD-MON-YYYY')),
 PARTITION p_trx23q3 VALUES LESS THAN (TO_DATE('01-OCT-2023', 'DD-MON-YYYY')),
 PARTITION p_trx23q4 VALUES LESS THAN (TO_DATE('01-JAN-2024', 'DD-MON-YYYY')));

-- Insert data into customer_transactions table.
INSERT INTO customer_transactions
SELECT TRUNC(DBMS_RANDOM.value(1,9999999999)) AS customer_id,
       TRUNC(TO_DATE('01-JAN-2022', 'DD-MON-YYYY') + DBMS_RANDOM.value(0,726)) AS trans_dte,
       ROUND(DBMS_RANDOM.value(1,2000000),2) AS trans_amt,
       DECODE(TRUNC(DBMS_RANDOM.value(1,6)),1,'NAMR',2,'SAMR',3,'ASIA',4,'EURO','MEAA')  AS region_cd,
       'N' AS processed_flg
FROM dual
CONNECT BY level <= 100000;
COMMIT;

SELECT TABLE_NAME,PARTITION_NAME,HIGH_VALUE FROM USER_TAB_PARTITIONS WHERE TABLE_NAME = 'CUSTOMER_TRANSACTIONS';

SELECT * FROM customer_transactions PARTITION(p_trx22q1) FETCH FIRST 10 ROWS ONLY;

INSERT INTO customer_transactions VALUES('4646464646',TO_DATE('15-JAN-2024', 'DD-MON-YYYY'),939000,'SAMR','N');
COMMIT;

SELECT TABLE_NAME,PARTITION_NAME,HIGH_VALUE FROM USER_TAB_PARTITIONS WHERE TABLE_NAME = 'CUSTOMER_TRANSACTIONS';

ALTER TABLE customer_transactions MODIFY PARTITION p_trx22q1 READ ONLY;

INSERT INTO customer_transactions VALUES('4646464646',TO_DATE('15-JAN-2022', 'DD-MON-YYYY'),487000,'SAMR','N');

-- Oracle Live SQL Results

Table created.

100000 row(s) inserted.

Statement processed.

TABLE_NAME                  PARTITION_NAME       HIGH_VALUE
CUSTOMER_TRANSACTIONS       P_TRX22Q1            TO_DATE(' 2022-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q2            TO_DATE(' 2022-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q3            TO_DATE(' 2022-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q4            TO_DATE(' 2023-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q1            TO_DATE(' 2023-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q2            TO_DATE(' 2023-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q3            TO_DATE(' 2023-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q4            TO_DATE(' 2024-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')

CUSTOMER_ID   TRANS_DTE     TRANS_AMT     REGION_CD     PROCESSED_FLG
6548156525    22-MAR-22     1622932.01    SAMR          N
3775015431    20-MAR-22     1501608.08    MEAA          N
8717312771    04-MAR-22     21290.53      ASIA          N
9223087499    24-MAR-22     1321276.15    EURO          N
7819549065    06-MAR-22     267739.93     MEAA          N
4631975036    13-FEB-22     1423351.27    ASIA          N
3346417037    16-FEB-22     80483.44      ASIA          N
5900479448    14-MAR-22     111266.15     NAMR          N
6089389880    01-MAR-22     8148.9        ASIA          N
2059492557    11-MAR-22     1545240.33    MEAA          N

1 row(s) inserted.

Statement processed.

TABLE_NAME                  PARTITION_NAME       HIGH_VALUE
CUSTOMER_TRANSACTIONS       P_TRX22Q1            TO_DATE(' 2022-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q2            TO_DATE(' 2022-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q3            TO_DATE(' 2022-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX22Q4            TO_DATE(' 2023-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q1            TO_DATE(' 2023-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q2            TO_DATE(' 2023-07-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q3            TO_DATE(' 2023-10-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       P_TRX23Q4            TO_DATE(' 2024-01-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')
CUSTOMER_TRANSACTIONS       SYS_P444533          TO_DATE(' 2024-04-01 00:00:00', 'SYYYY-MM-DD HH24:MI:SS', 'NLS_CALENDAR=GREGORIAN')

Table altered.

ORA-14466: Data in a read-only partition or subpartition cannot be modified. ORA-06512: at "SYS.DBMS_SQL", line 1721
